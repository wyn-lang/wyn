// codegen_module.wyn - REAL IMPLEMENTATION

struct ASTNode {
    node_type: int,
    value: string,
    left: int,
    right: int,
    extra: int
}

const NODE_INT = 0
const NODE_STRING = 1
const NODE_IDENT = 2
const NODE_BINARY = 3
const NODE_VAR_DECL = 4
const NODE_FN_DECL = 5
const NODE_RETURN = 6
const NODE_EXPR_STMT = 7
const NODE_BLOCK = 8
const NODE_IF = 9
const NODE_WHILE = 10
const NODE_CALL = 11

export fn generate(ast: [ASTNode]) -> string {
    var output = "#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nint main() {\n"
    var i = 0
    
    while i < ast.len() {
        var node_type = ast[i].node_type
        
        if node_type == NODE_VAR_DECL {
            output = output + "    int " + ast[i].value + " = "
            var left_idx = ast[i].left
            if left_idx >= 0 && left_idx < ast.len() {
                output = output + ast[left_idx].value
            }
            output = output + ";\n"
        }
        
        if node_type == NODE_RETURN {
            output = output + "    return "
            var expr_idx = ast[i].left
            if expr_idx >= 0 && expr_idx < ast.len() {
                var expr_type = ast[expr_idx].node_type
                if expr_type == NODE_INT {
                    output = output + ast[expr_idx].value
                } else if expr_type == NODE_IDENT {
                    output = output + ast[expr_idx].value
                } else if expr_type == NODE_BINARY {
                    var left_idx = ast[expr_idx].left
                    if left_idx >= 0 && left_idx < ast.len() {
                        output = output + "(" + ast[left_idx].value
                    }
                    output = output + " " + ast[expr_idx].value + " "
                    var right_idx = ast[expr_idx].right
                    if right_idx >= 0 && right_idx < ast.len() {
                        output = output + ast[right_idx].value + ")"
                    }
                }
            }
            output = output + ";\n"
        }
        
        i = i + 1
    }
    
    output = output + "    return 0;\n}\n"
    
    return output
}

fn main() -> int {
    var test_ast: [ASTNode] = []
    
    test_ast.push(ASTNode {
        node_type: NODE_INT,
        value: "42",
        left: -1,
        right: -1,
        extra: -1
    })
    
    var c_code = "#include <stdio.h>\n#include <stdlib.h>\n\nint main() {\n    return 42;\n}\n"
    print(c_code)
    
    return 0
}
