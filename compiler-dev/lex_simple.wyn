// Ultra-simple lexer - string-based tokens
var src = ""
var pos = 0

fn at_end() -> int {
    if pos >= src.len() { return 1 }
    return 0
}

fn curr() -> string {
    return src.substring(pos, pos + 1)
}

fn advance() -> int {
    pos = pos + 1
    return 0
}

fn skip_ws() -> int {
    while at_end() == 0 {
        var c = curr()
        if c == " " or c == "\n" or c == "\t" {
            advance()
        } else {
            return 0
        }
    }
    return 0
}

fn is_letter(c: string) -> int {
    if c == "a" or c == "b" or c == "c" or c == "d" or c == "e" { return 1 }
    if c == "f" or c == "g" or c == "h" or c == "i" or c == "j" { return 1 }
    if c == "k" or c == "l" or c == "m" or c == "n" or c == "o" { return 1 }
    if c == "p" or c == "q" or c == "r" or c == "s" or c == "t" { return 1 }
    if c == "u" or c == "v" or c == "w" or c == "x" or c == "y" { return 1 }
    if c == "z" or c == "_" { return 1 }
    return 0
}

fn is_digit(c: string) -> int {
    if c == "0" or c == "1" or c == "2" or c == "3" or c == "4" { return 1 }
    if c == "5" or c == "6" or c == "7" or c == "8" or c == "9" { return 1 }
    return 0
}

fn read_word() -> string {
    var start = pos
    while at_end() == 0 {
        var c = curr()
        if is_letter(c) == 1 or is_digit(c) == 1 {
            advance()
        } else {
            return src.substring(start, pos)
        }
    }
    return src.substring(start, pos)
}

fn read_number() -> string {
    var start = pos
    while at_end() == 0 and is_digit(curr()) == 1 {
        advance()
    }
    return src.substring(start, pos)
}

fn get_token() -> string {
    skip_ws()
    if at_end() == 1 { return "EOF" }
    
    var c = curr()
    
    if is_letter(c) == 1 {
        var w = read_word()
        if w == "fn" { return "FN" }
        if w == "var" { return "VAR" }
        if w == "return" { return "RETURN" }
        return "ID:" + w
    }
    
    if is_digit(c) == 1 {
        var num = read_number()
        return "NUM:" + num
    }
    
    if c == "-" {
        advance()
        if at_end() == 0 and curr() == ">" {
            advance()
            return "ARROW"
        }
        return "MINUS"
    }
    
    advance()
    if c == "(" { return "LPAREN" }
    if c == ")" { return "RPAREN" }
    if c == "{" { return "LBRACE" }
    if c == "}" { return "RBRACE" }
    if c == ":" { return "COLON" }
    if c == "," { return "COMMA" }
    if c == "+" { return "PLUS" }
    if c == "=" { return "EQ" }
    
    return "UNKNOWN"
}

fn main() -> int {
    src = File::read("input.wyn")
    pos = 0
    
    var out = ""
    var tok = get_token()
    var first = 1
    
    while tok != "EOF" {
        if first == 0 { out = out + "," }
        first = 0
        out = out + tok
        tok = get_token()
    }
    
    File::write("tokens.txt", out)
    print("Lexer complete\n")
    return 0
}
