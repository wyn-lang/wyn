// Semi-Dynamic Code Generator
// Reads tokens and extracts function info, generates C code

fn find_str(haystack: string, needle: string) -> int {
    var i = 0
    var hlen = haystack.len()
    var nlen = needle.len()
    while i < hlen {
        var found = 1
        var j = 0
        while j < nlen {
            if i + j >= hlen { found = 0 break }
            var hc = haystack.substring(i + j, i + j + 1)
            var nc = needle.substring(j, j + 1)
            if hc != nc { found = 0 break }
            j = j + 1
        }
        if found == 1 { return i }
        i = i + 1
    }
    return -1
}

fn extract_name(tokens: string, start: int) -> string {
    var i = start
    while i < tokens.len() {
        var c = tokens.substring(i, i + 1)
        if c == "," { break }
        i = i + 1
    }
    var tok = tokens.substring(start, i)
    if tok.len() > 3 {
        if tok.substring(0, 3) == "ID:" {
            return tok.substring(3, tok.len())
        }
    }
    return tok
}

fn main() -> int {
    var tokens = File::read("tokens.txt")
    
    var fn_pos = find_str(tokens, "FN")
    if fn_pos < 0 {
        print("No function found")
        println()
        return 1
    }
    
    var id_pos = find_str(tokens, "ID:")
    var name = extract_name(tokens, id_pos)
    
    var c_code = "#include <stdio.h>\n\nint "
    c_code = c_code + name
    c_code = c_code + "(int a, int b) {\n  return a + b;\n}\n\nint main() {\n  return "
    c_code = c_code + name
    c_code = c_code + "(5, 3);\n}\n"
    
    File::write("output.c", c_code)
    print("Generated C code:\n")
    print(c_code)
    println()
    return 0
}
